class efuAI{constructor(){this.root="https://summary.tianli0.top",this.aiTalkMode=!1,this.aiPostExplanation="",this.config=GLOBAL_CONFIG.post_ai,this.scoGPTIsRunning=!1}init(){document.querySelector(".ai-explanation")&&(this.scoGPTIsRunning=!1,this.aiPostExplanation=!!PAGE_CONFIG.ai_text&&PAGE_CONFIG.ai_text+"",this.aiPostExplanation?this.aiShowAnimation(Promise.resolve(this.aiPostExplanation)):this.generate(),this.AIEngine())}getTitleAndContent(){var e=document.getElementById("article-container"),t=document.title,n=e.getElementsByTagName("p"),e=e.querySelectorAll("h1, h2, h3, h4, h5");return(t+" "+Array.from(e).concat(Array.from(n)).map(e=>e.innerText.replace(/https?:\/\/[^\s]+/g,"")).join(" ")).slice(0,1e3)}async generate(){this.aiShowAnimation(this.fetch(document.title,this.getTitleAndContent(),this.config.key))}async fetch(e,t,n){t=`${this.root}/?content=${encodeURIComponent(t)}&title=${e}&key=${encodeURIComponent(n)}&url=`+encodeURIComponent(window.location.href),e=await fetch(t),n=await e.json();return e.ok?(this.aiPostExplanation=n.summary,n.summary):(console.error("Request failed:",n.err_msg),n.err_msg)}aiShowAnimation(t,h=!1){let g=document.querySelector(".ai-explanation"),m=document.querySelector(".ai-tag");if(g&&!this.scoGPTIsRunning){this.scoGPTIsRunning=!0,this.cleanSuggestions(),m.classList.add("loadingAI"),g.style.display="block",g.innerHTML='生成中...<span class="blinking-cursor"></span>';let o,a,r=!0,c=0,e=!0,l=new IntersectionObserver(e=>{(r=e[0].isIntersecting)&&requestAnimationFrame(a)},{threshold:0});t.then(s=>{o=performance.now(),a=()=>{var e,t,n,i;c<s.length&&r&&(t=(e=performance.now())-o,i=s.slice(c,c+1),n=/[，。！、？,.!?]/.test(i),i=/[a-zA-Z0-9]/.test(i),t>=(n?100*Math.random()+100:i?10:25)&&(g.innerText=s.slice(0,c+1),o=e,++c<s.length?g.innerHTML=s.slice(0,c)+'<span class="blinking-cursor"></span>':(g.innerHTML=s,g.style.display="block",this.scoGPTIsRunning=!1,m.classList.remove("loadingAI"),l.disconnect(),h&&this.createSuggestions())),r)&&requestAnimationFrame(a)},r&&e&&setTimeout(()=>{requestAnimationFrame(a),e=!1},3e3),l.observe(g)}).catch(e=>{console.error("检索信息失败：",e),g.innerHTML="检索信息失败",g.style.display="block",this.scoGPTIsRunning=!1,m.classList.remove("loadingAI"),l.disconnect()})}}AIEngine(){var e=document.querySelector(".ai-tag");e&&e.addEventListener("click",()=>{this.scoGPTIsRunning||(this.aiTalkMode=!0,this.aiShowAnimation(Promise.resolve(this.config.talk),!0))})}cleanSuggestions(){var e=document.querySelector(".ai-suggestions");e?e.innerHTML="":console.error("没有这个元素：'ai-suggestions'")}createSuggestions(){this.aiTalkMode&&(this.cleanSuggestions(),this.createSuggestionItemWithAction("这篇文章讲了什么？",()=>{""===this.aiPostExplanation?this.generate():this.aiShowAnimation(Promise.resolve(this.aiPostExplanation),!0)}),this.config.randomPost&&this.createSuggestionItemWithAction("带我去看看其他文章",()=>toRandomPost()),this.aiTalkMode=!0)}createSuggestionItemWithAction(e,t){var n,i=document.querySelector(".ai-suggestions");i?((n=document.createElement("div")).classList.add("ai-suggestions-item"),n.textContent=e,n.addEventListener("click",t),i.appendChild(n)):console.error("无法找到具有class为ai-suggestions的元素")}}let efu_ai=new efuAI;
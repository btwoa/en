(()=>{let l="SolitudeCache",s="https://id.v3/",e=()=>caches.match(s).then(e=>e?.json()),i=t=>caches.open(l).then(e=>e.put(s,new Response(JSON.stringify(t)))),c=(self.addEventListener("install",()=>{self.skipWaiting()}),self.addEventListener("activate",e=>e.waitUntil(clients.claim())),(e,t,n,r)=>((r=r||{}).cache=t?"no-store":"default",n&&(r.mode="cors",r.credentials="same-origin"),fetch(e,r))),n=(e,t,n)=>c(e,t,!0,n),h=e=>{if("localhost"!==e.hostname)for(var t in r){t=r[t];if(t.match(e))return t}},r={simple:{clean:!0,search:!1,match:e=>"blog.btwoa.com"===e.host&&["/404.html"].includes(e.pathname)},cdn:{clean:!0,match:e=>["cdn.cbd.int","lf26-cdn-tos.bytecdntp.com","lf6-cdn-tos.bytecdntp.com","lf3-cdn-tos.bytecdntp.com","lf9-cdn-tos.bytecdntp.com","cdn.staticfile.org","npm.elemecdn.com"].includes(e.host)&&e.pathname.match(/\.(js|css|woff2|woff|ttf|cur)$/)}},u=e=>{if(e.startsWith("https://npm.elemecdn.com"))return{timeout:3e3,list:[e,"https://fastly.jsdelivr.net/"+new URL(e).pathname]}},o=(l,e,i=null)=>{if(!i&&!(i=u(l.url)))return n(l,e);let c=i.list,h=new Array(c.length),o=t=>n(new Request(c[t],l),e,{signal:(h[t]=new AbortController).signal}).then(e=>f(e)?{r:e,i:t}:Promise.reject());return new Promise((n,e)=>{let t=!0,r=()=>{t=!1,Promise.any([a,...Array.from({length:c.length-1},(e,t)=>t+1).map(e=>o(e))]).then(t=>{for(let e=0;e!==c.length;++e)e!==t.i&&h[e].abort();n(t.r)}).catch(()=>e(`请求 ${l.url} 失败`))},s=setTimeout(r,i.timeout),a=o(0).then(e=>{t&&(clearTimeout(s),n(e.r))}).catch(()=>(t&&(clearTimeout(s),r()),Promise.reject()))})},f=e=>e.ok||[301,302,307,308].includes(e.status),a=(new Map,self.addEventListener("fetch",n=>{let r=n.request,e=new URL(r.url);if("GET"===r.method&&r.url.startsWith("http")&&!((s=r).url.startsWith("https://i0.hdslb.com")||s.url.startsWith("https://meting.qjqq.cn")||s.url.startsWith("https://api.i-meto.com"))){let t;e.hostname,e.pathname,e.search;var s=e=>{n.respondWith((t,e))},a=h(e);if(a){let n="https://"+e.host+e.pathname;n.endsWith("/index.html")&&(n=n.substring(0,n.length-10)),a.search&&(n+=e.search),s(caches.match(n).then(e=>e??o(r,!0).then(e=>{if(f(e)){let t=e.clone();caches.open(l).then(e=>e.put(n,t))}return e})))}else{let e=u(r.url);s(e?o(r,!1,e):(a=r,c(a,!1,!1,void 0).catch(e=>new Response(e,{status:499}))))}}}),self.addEventListener("message",t=>{"update"===t.data&&a().then(e=>{e.type="update",t.source.postMessage(e)})}),async()=>{var t=await o(new Request("/update.json"),!1);if(!f(t))throw"加载 update.json 时遇到异常，状态码："+t.status;var a,r,t=await t.json(),t=(a=t,await e().then(e=>{var t,{info:n,global:r}=a,s={global:r,local:n[0].version,escape:e?.escape??0};return e?(n=((n,e,r)=>{for(var s of e){let{version:e,change:t}=s;if(e===r)return!1;if(t)for(var a of t)n.push(new d(a))}return!0})(t=new m,n,e.local),i(s),n&&(r!==e.global?t.force=!0:t.refresh=!0),{list:t,new:s,old:e}):(s.escape=0,i(s),{new:s,old:e})}));if(t.list){r=t.list;let e=await caches.open(l).then(n=>n.keys().then(e=>Promise.all(e.map(async e=>{var t=e.url;return t!==s&&r.match(t)?(n.delete(e),t):null}))).then(e=>e.filter(e=>e)));t.list=e?.length?e:null}return t});function m(){let n=[];this.push=e=>{n.push(e)},this.match=e=>{if(this.force)return!0;if(e=new URL(e),this.refresh)return h(e).clean;for(var t of n)if(t.match(e))return!0;return!1}}function d(r){let e=e=>{var t=r.value;if(Array.isArray(t)){for(var n of t)if(e(n))return!0;return!1}return e(t)};this.match=(()=>{switch(r.flag){case"html":return e=>e.pathname.match(/(\/|\.html)$/);case"end":return t=>e(e=>t.href.endsWith(e));case"begin":return t=>e(e=>t.pathname.startsWith(e));case"str":return t=>e(e=>t.href.includes(e));case"reg":return t=>e(e=>t.href.match(new RegExp(e,"i")));default:throw"未知表达式："+JSON.stringify(r)}})()}})();